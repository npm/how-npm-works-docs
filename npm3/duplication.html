<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>npm3 Duplication | How npm Works</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    
        <link rel="stylesheet" href="../styles/website.css">
    

        
    
    
    <link rel="next" href="../npm3/non-determinism.html" />
    
    
    <link rel="prev" href="../npm3/how-npm3-works.html" />
    

        
    </head>
    <body>
        <header class="anonymous">
  <div class="header-item header-nav-menu-container">
    <a href="#" id="npm-expansions" class="npm-expansions" data-event-trigger="click" data-event-name="npm-expansions">New Project, Monday</a>
    <div class="nav-menu-container" role="navigation">
      <a class="nav-toggle drop-down-menu-toggle" href="#product-navigation"><span class="a11y-only">Toggle Navigation</span>
        <img alt="mobile navigation menu" src="/public/images/mobile-menu.png">
      </a>
      <div class="drop-down-menu-container" role="menu">
        <nav id="product-navigation" class="product-navigation drop-down-menu">
          <ul class="drop-down-menu-section products-list">
            <li><a href="https://www.npmjs.com/npm/on-site">npm On-Site</a></li>
            <li><a href="https://www.npmjs.com/npm/private-packages" data-event-trigger="click" data-event-name="private-modules-nav-link">npm Private Packages</a></li>
            <li><a href="https://www.npmjs.com/npm/open-source">npm Open Source</a></li>
            <li><a href="/">documentation</a></li>
            <li><a href="https://www.npmjs.com/support">support</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

        
    <div class="book"
        data-level="3.2"
        data-chapter-title="npm3 Duplication"
        data-filepath="npm3/duplication.md"
        data-basepath=".."
        data-revision="Fri May 13 2016 17:22:19 GMT+0000 (UTC)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="theory-and-design/index.html">
            
                
                    <a href="../theory-and-design/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Theory and Design
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="theory-and-design/what-is-a-package.html">
            
                
                    <a href="../theory-and-design/what-is-a-package.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        What is a package?
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="theory-and-design/file-and-directory-names.html">
            
                
                    <a href="../theory-and-design/file-and-directory-names.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        File and Directory Names
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="theory-and-design/dependency-hell.html">
            
                
                    <a href="../theory-and-design/dependency-hell.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                        Dependency Hell
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="theory-and-design/the-node-module-loader.html">
            
                
                    <a href="../theory-and-design/the-node-module-loader.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                        The Node Module Loader
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="npm2/index.html">
            
                
                    <a href="../npm2/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        npm2
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="npm2/how-npm2-works.html">
            
                
                    <a href="../npm2/how-npm2-works.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        How npm2 Works
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="npm3/index.html">
            
                
                    <a href="../npm3/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        npm3
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="npm3/how-npm3-works.html">
            
                
                    <a href="../npm3/how-npm3-works.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        How npm3 Works
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="3.2" data-path="npm3/duplication.html">
            
                
                    <a href="../npm3/duplication.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        npm3 Duplication
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="npm3/non-determinism.html">
            
                
                    <a href="../npm3/non-determinism.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                        npm3 Non-Determinism
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >How npm Works</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="npm3-duplication">npm3 Duplication</h1>
<p>Let&apos;s continue with our example before. Currently we have an application
that depends on 2 modules:</p>
<ul>
<li>Module-A, depends on Module B v1.0</li>
<li>Module-C, depends on Module B v2.0</li>
</ul>
<p><img src="../gitbook/images/appsofar.png" alt="our app so far"></p>
<p>Now we ask ourselves, what happens if we install another module that depends
on Module B v1.0? or Module B v2.0?</p>
<h2 id="example">Example</h2>
<p>Ok, so let&apos;s say we want to depend on another package, module D. Module D
depends on Module B v2.0, just like Module C.</p>
<p><img src="../gitbook/images/npm3deps5.png" alt="new module dep, D"></p>
<p>Because B v1.0 is already a top-level dependency, we cannot install B v2.0
as a top level dependency. Therefore Module B v2.0 is installed as a nested
dependency of Module D, even though we already have a copy installed, nested
beneath Module C.</p>
<p><img src="../gitbook/images/npm3deps6.png" alt="no dedupe"></p>
<p>If a secondary dependency is required by 2+ modules, but was not installed as
a top-level dependency in the directory hierarchy, it will be duplicated and
nested beneath the primary dependency.</p>
<p>However, if a secondary dependency is required by 2+ modules, but <em>is</em>
installed as a top-level dependency in the directory hierarchy, it will <em>not</em>
be duplicated, and will be shared by the primary dependencies that require it.</p>
<p>For example, let&apos;s say we now want to depend on Module E. Module E, like Module
A, depends on Module B v1.0.</p>
<p><img src="../gitbook/images/npm3deps7.png" alt="new module dep, E"></p>
<p>Because B v1.0 is already a top-level dependency, we do not need to duplicate
and nest it. We simply install Module E and it shares Module B v1.0 with
Module A.</p>
<p><img src="../gitbook/images/npm3deps8.png" alt="dedupe"></p>
<p>This appears like this in the terminal:</p>
<p><img src="../gitbook/images/tree2.png" alt="tree2"></p>
<p>Now-- what happens if we update Module A to v2.0, which depends on
Module B v2.0, <em>not</em> Module B v1.0?</p>
<p><img src="../gitbook/images/npm3deps9.png" alt="bump Module A to version 2, deps on Bv2"></p>
<p><strong>The key is to remember that install order matters.</strong></p>
<p>Even though Module A was installed first (as v1.0) via our <code>package.json</code>
(because it is ordered alphabetically), using the interactive <code>npm install</code>
command means that Module A v2.0 is the last package installed.</p>
<p>As a result, npm3 does the following things when we run <code>npm install mod-a@2 --save</code>:</p>
<ul>
<li>it removes Module A v1.0</li>
<li>it installs Modules A v2.0</li>
<li>it leaves Module Bv1.0 because Module E v1.0 still depends on it</li>
<li>it installs Module Bv2.0 as a nested dependency under Module A v2.0, since 
Module B v1.0 is already occupying the top level in the directory hierarchy</li>
</ul>
<p><img src="../gitbook/images/npm3deps10.png" alt="bv1.0 stays even though a doesn&apos;t dep on it anymore"></p>
<p>This looks like this in the terminal:</p>
<p><img src="../gitbook/images/tree3.png" alt="tree3"></p>
<p>Finally, let&apos;s also update Module E to v2.0, which also depends on Module B v2.0
instead of Module B v1.0, just like the Module A update.</p>
<p><img src="../gitbook/images/npm3deps11.png" alt="bump Module E to version 2, deps on Bv2"></p>
<p>npm3 performs the following things:</p>
<ul>
<li>it removes Module E v1.0</li>
<li>it installs Module E v2.0</li>
<li>it removes Module B v1.0 because nothing depends on it anymore</li>
<li>it installs Module B v2.0 in the top level of the directory because there is
no other version of Module B there</li>
</ul>
<p><img src="../gitbook/images/npm3deps12.png" alt="now we have Bv2.0 everywhere"></p>
<p>This looks like this in the terminal:</p>
<p><img src="../gitbook/images/tree4.png" alt="tree4"></p>
<p>Now, this is clearly not ideal. We have Module B v2.0 in nearly every directory.
To get rid of duplication, we can run:</p>
<pre><code>npm dedupe
</code></pre><p>This command resolves all of the packages dependencies on Module B v2.0 by
redirecting them to the top level copy of Module B v2.0 and removes all the
nested copies.</p>
<p><img src="../gitbook/images/npm3deps13.png" alt="deduped"></p>
<p>This looks like this in the terminal:</p>
<p><img src="../gitbook/images/tree5.png" alt="tree5"> </p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../npm3/how-npm3-works.html" class="navigation navigation-prev " aria-label="Previous page: How npm3 Works"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../npm3/non-determinism.html" class="navigation navigation-next " aria-label="Next page: npm3 Non-Determinism"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"layout":{"headerPath":"layouts/header.html","footerPath":"layouts/footer.html"},"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        <footer class="pane bg-npm-navy-1">

    <div class="container">
      <div class="row">
        <div class="col-md-4">
          <h3 class="h4 type-npm-pastel-3">You Need Help</h3>
          <hr class="divider-1">
          <ul class="list-unstyled h6 em-default">
            <li class="pbl"><a class="type-neutral-11" href="https://docs.npmjs.com">Documentation</a></li>
            <li class="pbl"><a class="type-neutral-11" href="/support">Support / Contact Us</a></li>
            <li class="pbl"><a class="type-neutral-11" href="http://status.npmjs.org/">Registry Status</a></li>
            <li class="pbl"><a class="type-neutral-11" href="https://github.com/npm/newww/issues">Website Issues</a></li>
            <li class="pbl"><a class="type-neutral-11" href="https://github.com/npm/npm/issues">CLI Issues</a></li>
            <li class="pbl"><a class="type-neutral-11" href="/policies/security">Security</a></li>
          </ul>
        </div>

        <div class="col-md-4">
<h3 class="h4 type-npm-pastel-3">About npm</h3>
          <hr class="divider-1">
          <ul class="list-unstyled h6 em-default">
            <li class="pbl"><a class="type-neutral-11" href="/about">About npm, Inc</a></li>
            <li class="pbl"><a class="type-neutral-11" href="/jobs">Jobs</a></li>
            <li class="pbl"><a class="type-neutral-11" href="/npm-weekly">npm Weekly</a></li>
            <li class="pbl"><a class="type-neutral-11" href="http://blog.npmjs.org">Blog</a></li>
            <li class="pbl"><a class="type-neutral-11" href="https://twitter.com/npmjs">Twitter</a></li>
            <li class="pbl"><a class="type-neutral-11" href="https://github.com/npm">GitHub</a></li>
          </ul>
        </div>

        <div class="col-md-4">
          <h3 class="h4 type-npm-pastel-3">Legal Stuff</h3>
          <hr class="divider-1">
          <ul class="list-unstyled h6 em-default">
            <li class="pbl"><a class="type-neutral-11" href="/policies/terms">Terms of Use</a></li>
            <li class="pbl"><a class="type-neutral-11" href="/policies/conduct">Code of Conduct</a></li>
            <li class="pbl"><a class="type-neutral-11" href="/policies/disputes">Package Name Disputes</a></li>
<li class="pbl"><a class="type-neutral-11" href="/policies/privacy">Privacy Policy</a></li>
            <li class="pbl"><a class="type-neutral-11" href="/policies/receiving-reports">Reporting Abuse</a></li>
            <li class="pbl"><a class="type-neutral-11" href="/policies/">Other policies</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div class="txt-c container">
      <a class="npm-loves-you type-neutral-11" href="/">
        npm loves you
      </a>
    </div>
  </footer>
<script src="scripts/bundle.js"></script>

    </body>
    
</html>
